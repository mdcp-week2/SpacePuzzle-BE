generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid()) @db.Uuid
  email        String        @unique
  nickname     String?
  googleId     String?       @unique
  parts        Int           @default(0)
  credits      Int           @default(20)
  stars        Int           @default(0)
  total_clears Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  gameRecords  GameRecord[]
  gameAttempts GameAttempt[]
  userItems    UserItem[]
  activityLogs ActivityLog[]
  userMilestones UserMilestone[]
  dailyPuzzleCompletions DailyPuzzleCompletion[]

  @@map("users")
}

model Apod {
  date         String       @id
  title        String
  description  String?      @db.Text
  imageUrl     String
  puzzleType   String
  difficulty   String       @default("normal")
  puzzleSeed   Int          @default(0)
  puzzleConfig Json
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  gameRecords  GameRecord[]

  @@map("apods")
}

model Sector {
  id             String            @id @default(uuid()) @db.Uuid
  slug           String            @unique
  name           String
  nameEn         String?
  description    String?
  displayOrder   Int               @default(0)
  requiredStars  Int               @default(0)
  unlockBonusCredits Int           @default(0)
  unlockBonusParts Int             @default(0)
  celestialObjects CelestialObject[]

  @@map("sectors")
}

model CelestialObject {
  id           String       @id @default(uuid()) @db.Uuid
  nasaId       String       @unique
  title        String
  nameEn       String?
  description  String?      @db.Text
  imageUrl     String
  category     String?
  sectorId     String?      @db.Uuid
  displayOrder Int          @default(0)
  puzzleType   String?
  difficulty   String?
  puzzleSeed   Int?
  gridSize     Int          @default(0)
  rewardStars  Int          @default(0)
  puzzleConfig Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  sector       Sector?      @relation(fields: [sectorId], references: [id], onDelete: SetNull)
  gameRecords  GameRecord[]

  @@map("celestial_objects")
}

model GameRecord {
  id                String           @id @default(uuid()) @db.Uuid
  userId            String           @db.Uuid
  apodDate          String?
  celestialObjectId String?          @db.Uuid
  puzzleType        String
  bestTime          Float?
  saveState         Json?
  isCompleted       Boolean          @default(false)
  completedAt       DateTime?
  lastAttemptAt     DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  apod              Apod?            @relation(fields: [apodDate], references: [date], onDelete: Cascade)
  object            CelestialObject? @relation(fields: [celestialObjectId], references: [id], onDelete: Cascade)
  attempts          GameAttempt[]

  @@unique([userId, apodDate, puzzleType])
  @@unique([userId, celestialObjectId, puzzleType])
  @@map("game_records")
}

model GameAttempt {
  id           String     @id @default(uuid()) @db.Uuid
  recordId     String     @db.Uuid
  userId       String     @db.Uuid
  startedAt    DateTime   @default(now())
  playTime     Float?
  isCompleted  Boolean    @default(false)
  completedAt  DateTime?
  saveState    Json?
  record       GameRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([recordId, isCompleted, playTime])
  @@map("game_attempts")
}

model Item {
  id        String     @id
  name      String
  type      String?
  rarity    String?
  priceType String?
  priceAmount Int?
  assetUrl  String?
  userItems UserItem[]

  @@map("items")
}

model UserItem {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  itemId     String
  isEquipped Boolean  @default(false)
  position   Json     @default("{\"x\": 0, \"y\": 0, \"z\": 0}")
  rotation   Json     @default("{\"x\": 0, \"y\": 0, \"z\": 0}")
  acquiredAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("user_items")
}

model ActivityLog {
  userId       String   @map("user_id") @db.Uuid
  activityDate DateTime @default(now()) @map("activity_date") @db.Date
  activityType String   @default("puzzle_clear")
  count        Int      @default(1)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, activityDate, activityType])
  @@map("activity_logs")
}


model StarMilestone {
  id                String   @id @default(uuid()) @db.Uuid
  requiredStars     Int      @unique
  rewardCredits     Int      @default(0)
  rewardParts       Int      @default(0)
  unlockSectorId    String?  @db.Uuid
  milestoneOrder    Int      @default(0)
  unlockSector      Sector?  @relation(fields: [unlockSectorId], references: [id], onDelete: SetNull)
  userMilestones    UserMilestone[]

  @@map("star_milestones")
}

model UserMilestone {
  id           String        @id @default(uuid()) @db.Uuid
  userId       String        @db.Uuid
  milestoneId  String        @db.Uuid
  achievedAt   DateTime      @default(now())
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestone    StarMilestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@unique([userId, milestoneId])
  @@map("user_milestones")
}

model DailyPuzzleCompletion {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  puzzleDate DateTime @db.Date
  playTime   Int
  partsEarned Int     @default(1)
  completedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, puzzleDate])
  @@map("daily_puzzle_completions")
}